import tkinter as tk
from tkinter import ttk
from core.cognitive_layer.meta_kernel_virtualization import MetaKernel
from core.cognitive_layer.orchestrator import Orchestrator
import threading
import time

# РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ СЏРґСЂР° Рё Orchestrator
mk = MetaKernel()
orch = Orchestrator()
mk.orchestrator = orch

# Р¤СѓРЅРєС†РёСЏ РґР»СЏ С†РІРµС‚РѕРІРѕР№ РёРЅРґРёРєР°С†РёРё
def color_status(ok):
    if ok is True:
        return 'green'
    elif ok is False:
        return 'red'
    else:
        return 'orange'

class JarvisLiveGUI:
    def __init__(self, root):
        self.root = root
        self.root.title('Jarvis-VCOS Live Monitor')

        self.tabControl = ttk.Notebook(root)

        # Р’РєР»Р°РґРєРё
        self.tab_log = ttk.Frame(self.tabControl)
        self.tab_snapshot = ttk.Frame(self.tabControl)
        self.tab_orch = ttk.Frame(self.tabControl)

        self.tabControl.add(self.tab_log, text='Decision Log')
        self.tabControl.add(self.tab_snapshot, text='Latest Snapshot')
        self.tabControl.add(self.tab_orch, text='Orchestrator Status')
        self.tabControl.pack(expand=1, fill='both')

        # Decision Log
        self.log_text = tk.Text(self.tab_log, height=20, width=80)
        self.log_text.pack()

        # Latest Snapshot
        self.snapshot_text = tk.Text(self.tab_snapshot, height=20, width=80)
        self.snapshot_text.pack()

        # Orchestrator Status
        self.orch_text = tk.Text(self.tab_orch, height=20, width=80)
        self.orch_text.pack()

        # РљРѕРјР°РЅРґРЅР°СЏ РїР°РЅРµР»СЊ
        self.cmd_label = tk.Label(root, text='Enter Command:')
        self.cmd_label.pack()
        self.cmd_entry = tk.Entry(root, width=50)
        self.cmd_entry.pack()
        self.run_button = tk.Button(root, text='Execute', command=self.run_command)
        self.run_button.pack()

        # Р—Р°РїСѓСЃРє С„РѕРЅРѕРІРѕРіРѕ РѕР±РЅРѕРІР»РµРЅРёСЏ
        self.update_loop()

    def run_command(self):
        cmd = self.cmd_entry.get()
        if not cmd:
            return
        result = mk.process_command(cmd)
        # РћР±РЅРѕРІР»РµРЅРёРµ Decision Log СЃ С†РІРµС‚РѕРІРѕР№ РёРЅРґРёРєР°С†РёРµР№
        for step in result['steps']:
            layer = step['layer']
            ok = step.get('ok') or step.get('review', {}).get('ok') or step.get('final', {}).get('ok')
            color = color_status(ok)
            self.log_text.insert(tk.END, f"{layer}: {ok}\n", layer)
            self.log_text.tag_config(layer, foreground=color)
        self.log_text.insert(tk.END, f"Command: {cmd}\nResult: {result['result']}\n\n")
        self.cmd_entry.delete(0, tk.END)

    def update_loop(self):
        # Р¤РѕРЅРѕРІРѕРµ РѕР±РЅРѕРІР»РµРЅРёРµ РєР°Р¶РґС‹Рµ 2 СЃРµРєСѓРЅРґС‹
        self.snapshot_text.delete('1.0', tk.END)
        snapshot = mk.get_latest_snapshot()
        self.snapshot_text.insert(tk.END, f"Latest Snapshot:\n{snapshot}")

        self.orch_text.delete('1.0', tk.END)
        status = orch.get_status() if hasattr(orch, 'get_status') else 'Orchestrator ready'
        self.orch_text.insert(tk.END, str(status))

        self.root.after(2000, self.update_loop)

# Р—Р°РїСѓСЃРє GUI
root = tk.Tk()
app = JarvisLiveGUI(root)
root.mainloop()
